{% extends "base.html" %}
{% block title %}{{ campaign.title }} - Helping Hand Together{% endblock %}
{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-lg-8">
            {% if campaign.image_path %}
            <img src="{{ campaign.image_path }}" class="img-fluid rounded mb-4" alt="{{ campaign.title }}">
            {% endif %}

            <h1 class="mb-3">{{ campaign.title }}</h1>

            <div class="d-flex gap-3 mb-4 text-muted">
                <span><i class="bi bi-person"></i> {{ campaign.owner.name }}</span>
                <span><i class="bi bi-geo-alt"></i> {{ campaign.location }}</span>
                <span><i class="bi bi-calendar"></i> {{ campaign.created_at.strftime('%B %d, %Y') }}</span>
            </div>

            <div class="mb-4">
                <h4>Raised: ${{ "%.2f"|format(campaign.raised_amount) }} of ${{ "%.2f"|format(campaign.goal_amount) }}</h4>
                <div class="progress mb-2" style="height: 20px;">
                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ campaign.progress_percentage() }}%">
                        {{ campaign.progress_percentage() }}%
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-body">
                    <h3>Campaign Story</h3>
                    <p class="lead">{{ campaign.description }}</p>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body">
                    <h4 class="mb-3">Recent Donations</h4>
                    {% if recent_donations %}
                        <div class="list-group list-group-flush">
                            {% for donation in recent_donations %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between">
                                    <strong>
                                        {% if donation.anonymous %}
                                            Anonymous
                                        {% else %}
                                            {{ donation.donor_name }}
                                        {% endif %}
                                    </strong>
                                    <span class="text-success fw-bold">
                                        ${{ "%.2f"|format(donation.amount) }}
                                    </span>
                                </div>
                                <small class="text-muted">
                                    {{ donation.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                                </small>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">Be the first to donate!</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 100px;">
                <div class="card-body">
                    <h4 class="card-title mb-4"><i class="bi bi-heart-fill text-danger"></i> Make a Donation</h4>

                    <form method="POST" action="{{ url_for('main.donate', id=campaign.id) }}" id="donationForm">
                        {{ form.hidden_tag() }}

                        <div class="mb-3">
                            {{ form.donor_name.label(class="form-label") }}
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-person"></i></span>
                                {{ form.donor_name(class="form-control", placeholder="Your Name") }}
                            </div>
                        </div>

                        <div class="mb-3">
                            {{ form.donor_email.label(class="form-label") }}
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                                {{ form.donor_email(class="form-control", placeholder="your@email.com") }}
                            </div>
                        </div>

                        <div class="mb-3">
                            {{ form.amount.label(class="form-label") }}
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-currency-dollar"></i></span>
                                {{ form.amount(class="form-control", placeholder="Enter amount") }}
                            </div>
                        </div>

                        <div class="mb-3">
                            {{ form.payment_method.label(class="form-label") }}
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-credit-card"></i></span>
                                {{ form.payment_method(class="form-select", id="paymentMethodSelect") }}
                            </div>
                            <small class="text-muted" id="paymentMethodHelp"></small>
                            <div id="paymentMethodDetails" class="mt-2" style="display: none;">
                                <div class="card card-body bg-light">
                                    <div id="methodDetailsContent"></div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3 form-check">
                            {{ form.anonymous(class="form-check-input", id="anonymousCheck") }}
                            {{ form.anonymous.label(class="form-check-label") }}
                        </div>

                        {{ form.submit(class="btn btn-primary w-100 btn-lg", value="Donate Now") }}
                        <div class="text-center mt-2">
                            <small class="text-muted"><i class="bi bi-shield-check"></i> Secure Payment Processing</small>
                        </div>
                    </form>

                    <script>
                        // Payment method configurations from backend
                        const paymentMethodsData = {
                            {% for method in payment_methods %}
                            "{{ method.id }}": {
                                name: "{{ method.name }}",
                                type: "{{ method.type }}",
                                details: "{{ method.details|safe }}",
                                {% if method.type == 'crypto' %}
                                crypto_currency: "{{ method.crypto_currency }}",
                                crypto_wallet_address: "{{ method.crypto_wallet_address }}",
                                {% elif method.type == 'bank' %}
                                bank_name: "{{ method.bank_name }}",
                                account_name: "{{ method.account_name }}",
                                account_number: "{{ method.account_number }}",
                                routing_number: "{{ method.routing_number or '' }}",
                                bank_address: "{{ method.bank_address or '' }}",
                                {% endif %}
                            },
                            {% endfor %}
                        };

                        document.getElementById('paymentMethodSelect').addEventListener('change', function() {
                            const helpText = document.getElementById('paymentMethodHelp');
                            const detailsDiv = document.getElementById('paymentMethodDetails');
                            const detailsContent = document.getElementById('methodDetailsContent');
                            const methodId = this.value;
                            
                            if (!methodId) {
                                helpText.innerHTML = '';
                                detailsDiv.style.display = 'none';
                                return;
                            }
                            
                            const methodData = paymentMethodsData[methodId];
                            if (!methodData) {
                                helpText.innerHTML = '';
                                detailsDiv.style.display = 'none';
                                return;
                            }

                            // Set help text based on payment type
                            if (methodData.type === 'paypal') {
                                helpText.innerHTML = '<i class="bi bi-info-circle"></i> You will be redirected to PayPal to complete your payment';
                            } else if (methodData.type === 'paystack') {
                                helpText.innerHTML = '<i class="bi bi-info-circle"></i> You will be redirected to Paystack for secure payment';
                            } else if (methodData.type === 'crypto') {
                                helpText.innerHTML = '<i class="bi bi-info-circle"></i> You will be provided with wallet address for cryptocurrency payment';
                                // Show crypto details
                                detailsContent.innerHTML = `
                                    <h6><i class="bi bi-currency-bitcoin"></i> ${methodData.crypto_currency} Payment</h6>
                                    <p><strong>Wallet Address:</strong><br>
                                    <code class="user-select-all">${methodData.crypto_wallet_address}</code></p>
                                    ${methodData.details ? `<p><small class="text-muted">${methodData.details}</small></p>` : ''}
                                `;
                                detailsDiv.style.display = 'block';
                                return;
                            } else if (methodData.type === 'bank') {
                                helpText.innerHTML = '<i class="bi bi-info-circle"></i> Bank transfer instructions will be provided after donation';
                                // Show bank details preview
                                detailsContent.innerHTML = `
                                    <h6><i class="bi bi-bank"></i> ${methodData.bank_name}</h6>
                                    <p><strong>Account:</strong> ${methodData.account_name}<br>
                                    <strong>Number:</strong> ${methodData.account_number}</p>
                                    ${methodData.details ? `<p><small class="text-muted">${methodData.details}</small></p>` : ''}
                                `;
                                detailsDiv.style.display = 'block';
                                return;
                            } else {
                                helpText.innerHTML = `<i class="bi bi-info-circle"></i> ${methodData.details || 'Payment method configured'}`;
                            }
                            
                            detailsDiv.style.display = 'none';
                        });
                    </script>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
